<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bursa Akıllı Otopark - HERE Dark Neon</title>
    
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #000; /* Arxa fon qara */
        }

        /* XƏRİTƏNİ QARALTMAQ VƏ NEON EFFEKTİ VERMƏK ÜÇÜN FİLTER 
           Bu hissə peyk görüntüsünü "Dark Mode" kimi göstərir.
           HERE Maps canvas üzerinde de aynen çalışacaktır.
        */
        #map {
            height: 100%;
            width: 100%;
            touch-action: none;
            background: #000;
        }
        .H_map, .H_map canvas {
            background: #000 !important;
        }

        #price-panel {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 380px;

            background: rgba(20, 20, 24, 0.75); /* Daha tünd fon */
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);

            padding: 20px;
            border-radius: 24px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            color: #ffffff;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .location-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .p-icon {
            background: #2979ff;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 0 10px #2979ff;
        }

        .status-badge {
            font-size: 12px;
            font-weight: 800;
            padding: 4px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* NEON STATUS RƏNGLƏRİ */
        .status-dolu {
            color: #ff003c;
            background: rgba(255, 0, 60, 0.15);
            border: 1px solid rgba(255, 0, 60, 0.3);
            box-shadow: 0 0 8px rgba(255, 0, 60, 0.2);
        }

        .status-bos {
            color: #00ff44;
            background: rgba(0, 255, 68, 0.15);
            border: 1px solid rgba(0, 255, 68, 0.3);
            box-shadow: 0 0 8px rgba(0, 255, 68, 0.2);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #ebebf5;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            padding-bottom: 8px;
        }

        .info-label {
            color: #a0a0a0;
        }

        .info-value {
            font-weight: 600;
            text-shadow: 0 0 5px rgba(255,255,255,0.2);
        }

        /* Naviqasiya Düyməsi Neon */
        .nav-btn {
            background: linear-gradient(90deg, #0055ff, #00aaff);
            color: white;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 136, 255, 0.4);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-btn:active {
            transform: scale(0.96);
            box-shadow: 0 0 10px rgba(0, 136, 255, 0.6);
        }

        .close-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #aaa;
            width: 100%;
            padding: 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }

        .plaka-box {
            font-family: 'Consolas', monospace;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #333;
            text-align: center;
            margin-bottom: 15px;
            color: #ffd700;
            font-size: 18px;
            letter-spacing: 2px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        
        /* HERE Maps Logo/Copyright Gizleme */
        .H_copyright, .H_logo { display: none !important; }
    </style>
    
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-harp.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>

    <div id="price-panel"></div>
    <div id="map"></div>

    <script>
        const varsayilanMerkez = { lat: 40.226991369791286, lng: 28.84528824528653 };
        const HERE_API_KEY = 'UO-tiV8ME4AYsgMrTay0yZ7Jmy6ahf_nhURpS-h03Kw'; // API Key eklendi

        let platform, map, ui, behavior, router;
        let sariRotaCizgisi; 
        let kullaniciKonumu = varsayilanMerkez;
        let sonKonum = null;
        let seciliHedef = null;
        let targetMarker = null;
        let kullaniciMarker = null;

        function initMap() {
            // 1. Platform Başlat
            platform = new H.service.Platform({
                'apikey': HERE_API_KEY
            });
            const preferredEngine =
                (H.Map && H.Map.EngineType && H.Map.EngineType.HARP) ? H.Map.EngineType.HARP : null;
            const layerOpts = { lg: 'tr', pois: false };
            if (preferredEngine) layerOpts.engineType = preferredEngine;
            let defaultLayers = platform.createDefaultLayers(layerOpts);

            const pickPanelLayer = (layers) => {
                const v = layers && layers.vector && layers.vector.normal;
                return (v && (v.mapnight || v.map)) || null;
            };

            let panelBaseLayer = pickPanelLayer(defaultLayers);
            if (!panelBaseLayer) {
                console.error("HERE base layer bulunamadi. API key veya katman yetkisini kontrol et.");
                return;
            }

            // 2. Harita Oluştur
            const panelMapOptions = {
                zoom: 19,
                center: varsayilanMerkez,
                pixelRatio: window.devicePixelRatio || 1
            };
            if (preferredEngine) panelMapOptions.engineType = preferredEngine;

            try {
                map = new H.Map(
                    document.getElementById("map"),
                    panelBaseLayer,
                    panelMapOptions
                );
            } catch (e) {
                console.warn("HARP motoru acilamadi, varsayilan motora geri donuluyor:", e);
                defaultLayers = platform.createDefaultLayers({ lg: 'tr', pois: false });
                panelBaseLayer = pickPanelLayer(defaultLayers);
                if (!panelBaseLayer) {
                    console.error("Fallback base layer da bulunamadi.");
                    return;
                }
                map = new H.Map(
                    document.getElementById("map"),
                    panelBaseLayer,
                    {
                        zoom: 19,
                        center: varsayilanMerkez,
                        pixelRatio: window.devicePixelRatio || 1
                    }
                );
            }
            
            // Pencere değişimini dinle
            window.addEventListener('resize', () => map.getViewPort().resize());

            // 3. Etkileşim ve UI
            behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
            // UI'yı tamamen kapatmıyoruz ama sadeleştiriyoruz.
            // Google kodunda disableDefaultUI: true vardı. 
            // Burada UI oluşturmazsak zoom butonları gelmez, ki mobilde genelde istenir.
            // Eğer hiç buton istemiyorsanız aşağıdaki satırı silebilirsiniz.
            // ui = H.ui.UI.createDefault(map, defaultLayers); 

            // 4. Routing Servisi
            router = platform.getRoutingService(null, 8);

            // 5. Kullanıcı Konum Takibi
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (p) => {
                        const yeniKonum = { lat: p.coords.latitude, lng: p.coords.longitude };
                        if (sonKonum && mesafeHesapla(sonKonum, yeniKonum) < 2) return;

                        kullaniciKonumu = yeniKonum;
                        sonKonum = yeniKonum;

                        updateUserMarker(yeniKonum);

                        if (seciliHedef) rotaGuncelle();
                    },
                    null,
                    { enableHighAccuracy: true, maximumAge: 3000 }
                );
            } else {
                updateUserMarker(varsayilanMerkez);
            }

            // 6. Verileri Çek ve Poligonları Çiz
            const getParkingData = async () => {
                for (const url of ['otoparklar.json', '/otoparklar.json']) {
                    try {
                        const sep = url.includes('?') ? '&' : '?';
                        const r = await fetch(`${url}${sep}t=${Date.now()}`, { cache: 'no-store' });
                        if (r.ok) return await r.json();
                    } catch (_) {}
                }
                throw new Error("Otopark verisi alinamadi");
            };

            getParkingData().then(data => {
                data.forEach(park => {
                    // Qaranlıq xəritədə görünməsi üçün parlaq NEON rənglər
                    let strokeColor = park.status === "DOLU" ? "#ff003c" : "#00ff44";
                    let fillColor = park.status === "DOLU" ? "rgba(255, 0, 60, 0.1)" : "rgba(0, 255, 68, 0.1)";

                    // HERE LineString (Poligon koordinatları)
                    let lineString = new H.geo.LineString();
                    park.coords.forEach(c => lineString.pushPoint(c));

                    let poly = new H.map.Polygon(lineString, {
                        style: {
                            lineWidth: 4,
                            strokeColor: strokeColor,
                            fillColor: fillColor
                        }
                    });

                    // Poligon Tıklama Olayı
                    poly.addEventListener('tap', function(evt) {
                        // Poligon merkezini bul (HERE kendi bounding box'ından bulur)
                        let center = poly.getGeometry().getBoundingBox().getCenter();
                        seciliHedef = center;
                        rotaGuncelle();
                        panelGoster(park);
                    });

                    map.addObject(poly);
                });
            }).catch(err => console.log("Veri okuma hatasi:", err));
        }

        function updateUserMarker(coord) {
            // Google'daki Mavi Daire Marker'ı HTML (DomMarker) ile yapıyoruz
            if (kullaniciMarker) {
                kullaniciMarker.setGeometry(coord);
            } else {
                const html = `
                <div style="
                    width: 20px; height: 20px;
                    background: #00aaff;
                    border: 3px solid white;
                    border-radius: 50%;
                    box-shadow: 0 0 10px rgba(0,0,0,0.5);
                "></div>`;
                
                const icon = new H.map.DomIcon(html);
                kullaniciMarker = new H.map.DomMarker(coord, { icon: icon });
                map.addObject(kullaniciMarker);
            }
        }

        function rotaGuncelle() {
            if (!seciliHedef) return;

            // HERE Routing v8
            const routingParameters = {
                'routingMode': 'fast',
                'transportMode': 'car',
                'origin': `${kullaniciKonumu.lat},${kullaniciKonumu.lng}`,
                'destination': `${seciliHedef.lat},${seciliHedef.lng}`,
                'return': 'polyline'
            };

            const onResult = function(result) {
                if (result.routes.length) {
                    const routeSection = result.routes[0].sections[0];
                    const linestring = H.geo.LineString.fromFlexiblePolyline(routeSection.polyline);

                    // Sarı Neon Çizgi
                    if (sariRotaCizgisi) {
                        sariRotaCizgisi.setGeometry(linestring);
                    } else {
                        sariRotaCizgisi = new H.map.Polyline(linestring, {
                            style: { lineWidth: 6, strokeColor: '#ffea00' },
                            zIndex: 500
                        });
                        map.addObject(sariRotaCizgisi);
                    }

                    // Hedef Markeri (Pin)
                    if (targetMarker) map.removeObject(targetMarker);
                    targetMarker = new H.map.Marker(seciliHedef);
                    map.addObject(targetMarker);
                }
            };

            const onError = function(error) {
                console.log('Rota hatası:', error);
            };

            router.calculateRoute(routingParameters, onResult, onError);
        }

        function mesafeHesapla(k1, k2) {
            const R = 6371e3;
            const dLat = (k2.lat - k1.lat) * Math.PI / 180;
            const dLng = (k2.lng - k1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(k1.lat * Math.PI / 180) * Math.cos(k2.lat * Math.PI / 180) * Math.sin(dLng / 2) * Math.sin(dLng / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function ucretHesapla(ts) {
            if (!ts) ts = new Date().getTime();
            const fark = Math.ceil((new Date() - new Date(ts)) / 3600000);
            let u = 0;
            if (fark == 2) u = 150; else if (fark == 3) u = 200; else if (fark > 3) u = 200 + (fark - 3) * 100;
            return { ucret: u, saat: fark };
        }

        function panelGoster(park) {
            const p = document.getElementById("price-panel");
            const res = ucretHesapla(park.giris_timestamp);

            const durumText = park.status || "DOLU";
            const durumClass = durumText === "BOŞ" ? "status-bos" : "status-dolu";
            const baslik = park.bolge_adi || "A-12 BÖLGESI";
            
            // Renk hesaplama (metin içindeki span için)
            const ucretRengi = "#00ff44";

            // Şəkilə uyğun Glassmorphism Panel
            p.innerHTML = `
                <div class="panel-header">
                    <div class="location-title">
                        <div class="p-icon">P</div>
                        ${baslik}
                    </div>
                    <span class="status-badge ${durumClass}">${durumText}</span>
                </div>

                ${park.plaka ? `<div class="plaka-box">${park.plaka}</div>` : ''}

                <div class="info-grid">
                    <div class="info-row">
                        <span class="info-label">Mesafe</span>
                        <span class="info-value">23,0 km</span> </div>
                    <div class="info-row">
                        <span class="info-label">Süre</span>
                        <span class="info-value">${res.saat} Saat (Canlı)</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ücret</span>
                        <span class="info-value" style="color: ${ucretRengi}">${res.ucret} TL</span>
                    </div>
                     <div class="info-row">
                        <span class="info-label">Giriş Saati</span>
                        <span class="info-value">${park.giris_saati || '--:--'}</span>
                    </div>
                </div>

                <button class="nav-btn" onclick="alert('Naviqasiya başladılır...')">
                    NAVİGASYONU BAŞLAT &#10140;
                </button>
                <button class="close-btn" onclick="document.getElementById('price-panel').style.display='none'">
                    KAPAT
                </button>
            `;

            p.style.display = "block";
        }
        
        // Sayfa yüklenince haritayı başlat
        window.addEventListener('load', initMap);
    </script>
</body>
</html>
